# MeshLabeler 用户手册

## 目录
- [简介](#简介)
- [系统要求](#系统要求)
- [安装](#安装)
- [快速入门](#快速入门)
- [功能详解](#功能详解)
- [快捷键参考](#快捷键参考)
- [常见问题](#常见问题)
- [技巧与最佳实践](#技巧与最佳实践)

---

## 简介

MeshLabeler 是一款基于 VTK 和 Qt 开发的 3D 网格标注工具，专为科研和工程应用设计。

### 主要特性
- ✅ 支持 STL、VTP 格式
- ✅ 两种标注模式：画刷模式和单点模式
- ✅ 20 种可自定义标签
- ✅ 撤销/重做功能
- ✅ 自动保存（每 5 分钟）
- ✅ 实时 3D 可视化
- ✅ 特征边缘显示

---

## 系统要求

### 最低配置
- **操作系统**: Windows 10/11, Linux, macOS
- **CPU**: 双核 2.0 GHz
- **内存**: 4 GB RAM
- **显卡**: 支持 OpenGL 3.3+
- **存储**: 200 MB 可用空间

### 推荐配置
- **CPU**: 四核 3.0 GHz 或更高
- **内存**: 8 GB RAM 或更多
- **显卡**: 独立显卡，2 GB 显存

### 依赖库
- Qt 5.12 或更高版本
- VTK 8.2 或更高版本

---

## 安装

### Windows

1. 下载最新的 Windows 安装包 `MeshLabeler-Windows-x64.exe`
2. 双击运行安装程序
3. 按照向导完成安装
4. 从开始菜单或桌面快捷方式启动程序

### Linux

```bash
# 使用 CMake 构建
mkdir build && cd build
cmake ..
make
sudo make install

# 运行
MeshLabeler
```

### macOS

```bash
# 使用 Homebrew 安装依赖
brew install qt vtk

# 构建
mkdir build && cd build
cmake ..
make

# 运行
./bin/MeshLabeler
```

---

## 快速入门

### 1. 加载网格文件

**方法一：菜单加载**
1. 点击 **"输入文件"** 按钮
2. 在文件对话框中选择 STL 或 VTP 文件
3. 点击 **"打开"**

**方法二：自动加载**
- 程序启动时会自动加载上次打开的文件

### 2. 选择标注模式

MeshLabeler 提供两种标注模式：

#### 画刷模式（默认）
- 按 `R` 键切换到画刷模式
- 使用球形区域进行大面积标注
- 适合标注连续的大块区域

#### 单点模式
- 按 `S` 键切换到单点模式
- 逐个三角形面片标注
- 适合精细标注和修正

### 3. 选择标签

- 按数字键 `0-9` 选择标签编号
- 或者使用界面上的 SpinBox 选择
- 当前标签会在画刷球体颜色中显示

### 4. 开始标注

**画刷模式下：**
1. 移动鼠标到要标注的区域
2. 会显示一个半透明的球体预览
3. 按住鼠标左键并拖动进行标注
4. 球体范围内的面片会被标记为当前标签

**单点模式下：**
1. 移动鼠标到要标注的面片
2. 可以看到网格边缘线
3. 按住鼠标左键并移动鼠标标注单个面片

### 5. 调整画刷大小

- 按住 `Ctrl` + 鼠标滚轮向前：增大画刷
- 按住 `Ctrl` + 鼠标滚轮向后：减小画刷
- 画刷球体会实时更新显示

### 6. 视图操作

- **旋转视图**：右键拖拽
- **平移视图**：中键拖拽
- **缩放视图**：滚轮滚动（不按 Ctrl）

### 7. 撤销和重做

- **撤销**：`Ctrl + Z`
- **重做**：`Ctrl + Y`
- 支持最多 100 步历史记录

### 8. 保存结果

1. 点击 **"输出文件"** 按钮
2. 选择保存位置和文件名
3. 文件会保存为 VTP 格式
4. VTP 文件包含网格数据和标签信息

---

## 功能详解

### 画刷模式详解

画刷模式使用 **BFS（广度优先搜索）算法** 在球形区域内智能标注：

1. **球体范围检测**
   - 只有顶点在球体范围内的三角形会被标注
   - 可以精确控制标注区域

2. **连通性扩散**
   - 从点击的三角形开始
   - 沿着网格拓扑结构扩散
   - 自动标注相邻的符合条件的面片

3. **优势**
   - 快速标注大面积区域
   - 自动处理复杂的拓扑结构
   - 避免标注不连续的区域

### 单点模式详解

单点模式提供精确控制：

1. **边缘显示**
   - 切换到单点模式后会显示所有边缘
   - 更容易看清三角形边界

2. **逐个标注**
   - 每次只标注一个三角形
   - 适合修正错误标注
   - 适合处理细小区域

3. **使用场景**
   - 标注边界区域
   - 修正画刷模式的误标注
   - 处理复杂拓扑

### VTP 文件格式

VTP（VTK XML PolyData）格式的优势：

- 包含完整的网格几何信息
- 包含标签数据（CellData）
- 人类可读的 XML 格式
- 支持继续编辑（加载 VTP 文件可以继续标注）

**文件结构示例**：
```xml
<VTKFile type="PolyData">
  <PolyData>
    <Piece NumberOfPoints="..." NumberOfCells="...">
      <Points>...</Points>
      <Polys>...</Polys>
      <CellData>
        <DataArray type="Float32" Name="Label">
          0 1 1 2 2 2 ...
        </DataArray>
      </CellData>
    </Piece>
  </PolyData>
</VTKFile>
```

### 自动保存

**工作原理**：
- 每 5 分钟自动保存一次
- 保存到当前文件所在目录
- 文件名格式：`autosave_YYYYMMDD_HHMMSS.vtp`

**恢复崩溃数据**：
1. 查找最近的自动保存文件
2. 使用 "输入文件" 加载该文件
3. 继续标注工作

### 标签统计

程序会在控制台输出标签统计信息：

```
Total cells: 50000
Label 0: 30000 cells (60.0%)
Label 1: 15000 cells (30.0%)
Label 2: 5000 cells (10.0%)
```

---

## 快捷键参考

### 模式切换
| 按键 | 功能 |
|------|------|
| `R` | 切换到画刷模式 |
| `S` | 切换到单点模式 |

### 标签选择
| 按键 | 功能 |
|------|------|
| `0-9` | 选择标签编号 0-9 |

### 画刷控制
| 按键 | 功能 |
|------|------|
| `Ctrl + 滚轮↑` | 增大画刷半径 |
| `Ctrl + 滚轮↓` | 减小画刷半径 |

### 标注操作
| 按键/鼠标 | 功能 |
|-----------|------|
| 左键按住 + 拖动 | 标注区域/面片 |
| 左键点击 | 标注单个位置 |

### 视图控制
| 按键/鼠标 | 功能 |
|-----------|------|
| 右键拖动 | 旋转视图 |
| 中键拖动 | 平移视图 |
| 滚轮 | 缩放视图 |

### 编辑操作
| 按键 | 功能 |
|------|------|
| `Ctrl + Z` | 撤销 |
| `Ctrl + Y` | 重做 |

---

## 常见问题

### Q1: 为什么我的 STL 文件无法加载？

**可能原因**：
1. 文件损坏或格式不正确
2. 文件路径包含中文或特殊字符
3. 文件过大导致内存不足

**解决方法**：
- 使用其他工具验证 STL 文件有效性
- 将文件移到英文路径下
- 尝试简化网格（减少面片数量）

### Q2: 画刷标注没有反应？

**检查项目**：
1. 确认已切换到画刷模式（按 `R`）
2. 确认鼠标点击在网格上（cellId ≥ 0）
3. 确认球体半径不是太小

### Q3: 如何清除所有标注？

**方法**：
1. 选择标签 0（白色/背景）
2. 使用画刷模式
3. 增大画刷半径
4. 在整个网格上标注

### Q4: 撤销功能失效？

**说明**：
- 撤销历史最多保存 100 步
- 超过 100 步会丢弃最旧的历史
- 重新加载文件会清空历史

### Q5: 自动保存文件在哪里？

**位置**：
- 与当前打开的文件在同一目录
- 文件名：`autosave_YYYYMMDD_HHMMSS.vtp`
- 按时间戳排序，最新的在最后

### Q6: 如何提高标注速度？

**技巧**：
1. 使用画刷模式标注大块区域
2. 适当增大画刷半径
3. 使用单点模式修正边界
4. 善用撤销/重做功能

### Q7: 网格加载很慢怎么办？

**优化方法**：
1. 使用网格简化工具减少面片数量
2. 升级硬件（更多内存、更快的 CPU）
3. 分批处理大型网格

### Q8: 能否自定义标签颜色？

**当前版本**：
- 使用 VTK 默认颜色查找表
- 标签 0 固定为白色

**未来版本**：
- 计划添加自定义颜色功能
- 可以在标签管理界面中设置

---

## 技巧与最佳实践

### 1. 高效标注工作流

**推荐流程**：
```
1. 加载 STL 文件
2. 使用画刷模式快速标注主要区域
3. 切换到单点模式修正边界
4. 保存为 VTP 文件
5. 后续可以加载 VTP 继续编辑
```

### 2. 画刷半径设置建议

| 网格密度 | 推荐半径 | 说明 |
|---------|---------|------|
| 粗糙网格 (< 1000 面片) | 5-10 | 大半径快速标注 |
| 中等网格 (1000-10000) | 2-5 | 平衡速度和精度 |
| 精细网格 (> 10000) | 1-3 | 小半径精确控制 |

### 3. 标签规划

**建议**：
- 提前规划标签用途
- 使用一致的标签方案
- 标签 0 保留为背景/未标注

**示例方案**：
```
0: 背景/未标注
1: 区域 A
2: 区域 B
3: 区域 C
...
```

### 4. 处理复杂网格

**技巧**：
1. **分区标注**
   - 先标注明显区域
   - 再处理交界处
   - 最后修正细节

2. **多视角确认**
   - 旋转视图从多个角度查看
   - 确保没有遗漏
   - 检查标注一致性

3. **使用撤销功能**
   - 不要害怕犯错
   - 随时可以撤销重来
   - 实验不同的标注策略

### 5. 数据备份

**重要提示**：
- 定期手动保存（不要只依赖自动保存）
- 保存多个版本（v1, v2, v3...）
- 重要数据使用版本控制（Git）

**示例命名**：
```
model_v1_initial.vtp
model_v2_major_regions.vtp
model_v3_refined.vtp
model_final.vtp
```

### 6. 性能优化

**加速技巧**：
1. 关闭不必要的程序释放内存
2. 使用 Release 构建版本（不是 Debug）
3. 处理大型网格前先简化
4. 定期重启程序清理内存

---

## 联系与支持

### 报告问题
- GitHub Issues: https://github.com/SchwarzSolomon/MeshLabeler/issues

### 参与贡献
- 欢迎提交 Pull Request
- 查看 CONTRIBUTING.md 了解贡献指南

### 文档更新
- 本手册最后更新：2026-01-11
- 适用版本：MeshLabeler 2.0.0

---

## 更新日志

### v2.0.0 (2026-01-11)
- ✨ 重大架构重构
- ✅ 修复 BFS 递归栈溢出问题
- ✅ 添加撤销/重做功能
- ✅ 支持 VTP 文件加载
- ✅ 实现自动保存
- ✅ 优化渲染性能
- ✅ 完整的错误处理
- 📖 完善的文档

### v1.0.0 (初始版本)
- 基本的 STL 加载和标注功能
- 画刷和单点两种模式
- VTP 文件导出

---

**祝您使用愉快！**
